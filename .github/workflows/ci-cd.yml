name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test & Quality Checks

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitrecipes_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linting
        run: bun run lint

      - name: Run format check
        run: bun run format:check

      - name: Generate Prisma client
        run: bun run db:generate

      - name: Run tests
        run: bun run test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fitrecipes_test?schema=public
          JWT_SECRET: test-jwt-secret-for-ci-pipeline
          SUPABASE_URL: https://test.supabase.co
          SUPABASE_ANON_KEY: test-anon-key
          SUPABASE_SERVICE_ROLE_KEY: test-service-key
          SUPABASE_STORAGE_BUCKET: test-bucket

  build:
    runs-on: ubuntu-latest
    name: Build & Security
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate Prisma client
        run: bun run db:generate

      - name: Build application
        run: bun run build

      - name: Build Docker image
        run: docker build -t fitrecipes-backend .

  security:
    runs-on: ubuntu-latest
    name: Security Scan
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'

  deploy:
    runs-on: ubuntu-latest
    name: Deploy & Verify
    needs: [test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deployment Status
        run: |
          echo "âœ… All checks passed!"
          echo "ğŸš€ Triggering deployment to Render"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message }}"
          echo "ğŸ‘¤ Author: ${{ github.event.head_commit.author.name }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"

      - name: Wait for Render Deployment
        run: |
          echo "â³ Waiting for Render to complete deployment..."
          echo "ğŸ”„ Render auto-deploy triggered by this push"
          sleep 60  # Give Render time to start deployment

      - name: Health Check - Wait for Service
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          echo "ğŸ¥ Performing health checks..."
          
          # Configure health check parameters
          MAX_ATTEMPTS=30
          WAIT_TIME=10
          
          if [ -z "$RENDER_APP_URL" ]; then
            echo "âš ï¸  RENDER_APP_URL secret not set"
            echo "ğŸ“ Please add your Render app URL to GitHub secrets"
            echo "ğŸ”— Format: https://your-app-name.onrender.com"
            echo "â„¹ï¸  Skipping automated health checks for now"
            exit 0
          fi
          
          HEALTH_URL="$RENDER_APP_URL/health"
          
          echo "ğŸ¯ Health check URL: $HEALTH_URL"
          echo "â±ï¸  Max attempts: $MAX_ATTEMPTS (${MAX_ATTEMPTS}0 seconds timeout)"
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "ğŸ”„ Attempt $i/$MAX_ATTEMPTS..."
            
            if curl -f -s --max-time 10 "$HEALTH_URL" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              echo "ğŸ‰ Deployment verified successfully"
              break
            else
              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
                echo "ğŸš¨ Deployment might have issues"
                exit 1
              else
                echo "â³ Service not ready yet, waiting ${WAIT_TIME}s..."
                sleep $WAIT_TIME
              fi
            fi
          done

      - name: Verify API Endpoints
        if: success()
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          if [ -z "$RENDER_APP_URL" ]; then
            echo "âš ï¸  Skipping API verification - RENDER_APP_URL not set"
            exit 0
          fi
          
          BASE_URL="$RENDER_APP_URL"
          
          echo "ğŸ§ª Testing API endpoints..."
          
          # Test health endpoint and extract response
          echo "ğŸ“ Testing /health endpoint..."
          HEALTH_RESPONSE=$(curl -s "$BASE_URL/health" || echo "failed")
          
          if echo "$HEALTH_RESPONSE" | grep -q "healthy"; then
            echo "âœ… Health endpoint working"
            echo "ğŸ“Š Response: $HEALTH_RESPONSE"
          else
            echo "âŒ Health endpoint failed"
            echo "ğŸ“Š Response: $HEALTH_RESPONSE"
          fi
          
          # Test API base endpoint
          echo "ğŸ“ Testing /api/v1 endpoint..."
          API_RESPONSE=$(curl -s -w "%{http_code}" "$BASE_URL/api/v1" || echo "failed")
          
          if [[ "$API_RESPONSE" == *"200"* ]] || [[ "$API_RESPONSE" == *"404"* ]]; then
            echo "âœ… API endpoint accessible"
          else
            echo "âš ï¸  API endpoint response: $API_RESPONSE"
          fi

      - name: Deployment Summary
        if: always()
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          echo "ğŸ“‹ Deployment Summary"
          echo "===================="
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.event.head_commit.author.name }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo "â° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          if [ -n "$RENDER_APP_URL" ]; then
            echo "ğŸš€ App URL: $RENDER_APP_URL"
            echo "ğŸ¥ Health: $RENDER_APP_URL/health"
            echo "ğŸ”— API: $RENDER_APP_URL/api/v1"
          else
            echo "âš ï¸  Add RENDER_APP_URL secret for automated verification"
          fi

      - name: Notify Deployment Status
        if: failure()
        run: |
          echo "ğŸš¨ DEPLOYMENT VERIFICATION FAILED"
          echo "=================================="
          echo "âŒ The deployment verification process failed"
          echo "ğŸ” Check the logs above for specific errors"
          echo "ğŸ”— Render Dashboard: https://dashboard.render.com"
          echo "ğŸ“ Check your Render service logs for details"