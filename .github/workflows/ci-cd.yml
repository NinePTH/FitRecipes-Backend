name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test & Quality Checks

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitrecipes_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linting
        run: bun run lint

      - name: Run TypeScript check
        run: bun run type-check

      - name: Run format check
        run: bun run format:check

      - name: Generate Prisma client
        run: bun run db:generate

      - name: Run tests
        run: bun run test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fitrecipes_test?schema=public
          JWT_SECRET: test-jwt-secret-for-ci-pipeline
          SUPABASE_URL: https://test.supabase.co
          SUPABASE_ANON_KEY: test-anon-key
          SUPABASE_SERVICE_ROLE_KEY: test-service-key
          SUPABASE_STORAGE_BUCKET: test-bucket

  build:
    runs-on: ubuntu-latest
    name: Build & Security
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate Prisma client
        run: bun run db:generate

      - name: Build application
        run: bun run build

      - name: Build Docker image
        run: docker build -t fitrecipes-backend .

  security:
    runs-on: ubuntu-latest
    name: Security Scan
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'

  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production (Main)
    needs: [test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pre-Deployment Status
        run: |
          echo "âœ… All CI/CD checks passed!"
          echo "ï¿½ï¸ Initiating CONTROLLED deployment to Render"
          echo "ðŸ“ Commit: ${{ github.event.head_commit.message }}"
          echo "ðŸ‘¤ Author: ${{ github.event.head_commit.author.name }}"
          echo "ðŸ”— Repository: ${{ github.repository }}"
          echo "â° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Deploy to Render (Controlled)
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ -z "$RENDER_SERVICE_ID" ] || [ -z "$RENDER_API_KEY" ]; then
            echo "âš ï¸  RENDER_SERVICE_ID or RENDER_API_KEY secrets not set"
            echo "ðŸ“ Please add Render API credentials to GitHub secrets:"
            echo "   1. Go to Render Dashboard â†’ Account Settings â†’ API Keys"
            echo "   2. Create API key and copy it"
            echo "   3. Find service ID from URL: srv-xxxxx"
            echo "   4. Add both as GitHub secrets"
            echo ""
            echo "ðŸ”„ Falling back to monitoring existing deployment..."
            echo "â„¹ï¸  Render auto-deploy may still be active"
          else
            echo "ðŸš€ Triggering controlled deployment via Render API..."
            
            # Trigger deployment via Render API
            echo "ðŸ” Testing API credentials first..."
            
            # Test API access
            TEST_RESPONSE=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID" || echo "failed")
            
            if echo "$TEST_RESPONSE" | grep -q "name"; then
              echo "âœ… API credentials valid"
              
              # Trigger deployment with correct payload
              DEPLOY_RESPONSE=$(curl -s -X POST \
                "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
                -H "Authorization: Bearer $RENDER_API_KEY" \
                -H "Content-Type: application/json" \
                --data-raw '{}' || echo "failed")
            else
              echo "âŒ API credentials invalid or service not found"
              echo "ðŸ“Š Test Response: $TEST_RESPONSE"
              DEPLOY_RESPONSE="failed"
            fi
            
            if echo "$DEPLOY_RESPONSE" | grep -q "id"; then
              # Extract key information from response
              DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 | head -1)
              COMMIT_ID=$(echo "$DEPLOY_RESPONSE" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 | tail -1)
              STATUS=$(echo "$DEPLOY_RESPONSE" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              CREATED_AT=$(echo "$DEPLOY_RESPONSE" | grep -o '"createdAt":"[^"]*"' | cut -d'"' -f4)
              
              echo "âœ… Deployment triggered successfully!"
              echo "=================================="
              echo "ðŸ†” Deploy ID: $DEPLOY_ID"
              echo "ï¿½ Commit: ${COMMIT_ID:0:8}"
              echo "ï¿½ðŸ“Š Status: $STATUS"
              echo "â° Started: $CREATED_AT"
              echo "ðŸ”— Monitor: https://dashboard.render.com/web/$RENDER_SERVICE_ID"
              echo "=================================="
            elif [ "$DEPLOY_RESPONSE" = "failed" ]; then
              echo "âŒ Deployment API Call Failed"
              echo "=============================="
              echo "ðŸ” Check your GitHub secrets:"
              echo "   â€¢ RENDER_SERVICE_ID (srv-xxxxx...)"
              echo "   â€¢ RENDER_API_KEY (rnd_xxxxx...)"
              echo "ï¿½ Go to: Settings â†’ Secrets â†’ Actions"
              echo "=============================="
            else
              echo "âš ï¸  Unexpected Deployment Response"
              echo "=================================="
              echo "ðŸ“Š Raw Response:"
              echo "$DEPLOY_RESPONSE" | sed 's/,/,\n   /g' | sed 's/{/{\n   /' | sed 's/}/\n}/'
              echo ""
              echo "ðŸ” Possible causes:"
              echo "   â€¢ API format changes"
              echo "   â€¢ Service temporarily unavailable"
              echo "   â€¢ Network connectivity issues"
              echo "ðŸ”„ Continuing with verification..."
              echo "=================================="
            fi
          fi

      - name: Verify Deployment Health
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          echo "ðŸ¥ Verifying deployment completion via health checks..."
          
          # Configure health check parameters
          MAX_ATTEMPTS=30
          WAIT_TIME=10
          
          if [ -z "$RENDER_APP_URL" ]; then
            echo "âš ï¸  RENDER_APP_URL secret not set"
            echo "ðŸ“ Please add your Render app URL to GitHub secrets"
            echo "ðŸ”— Format: https://your-app-name.onrender.com"
            echo "â„¹ï¸  Skipping automated health checks for now"
            exit 0
          fi
          
          HEALTH_URL="$RENDER_APP_URL/health"
          
          echo "ðŸŽ¯ Health check URL: $HEALTH_URL"
          echo "â±ï¸  Max attempts: $MAX_ATTEMPTS (${MAX_ATTEMPTS}0 seconds timeout)"
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "ðŸ”„ Attempt $i/$MAX_ATTEMPTS..."
            
            if curl -f -s --max-time 10 "$HEALTH_URL" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              echo "ðŸŽ‰ Deployment verified successfully"
              break
            else
              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
                echo "ðŸš¨ Deployment might have issues"
                exit 1
              else
                echo "â³ Service not ready yet, waiting ${WAIT_TIME}s..."
                sleep $WAIT_TIME
              fi
            fi
          done

      - name: Verify API Endpoints
        if: success()
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          if [ -z "$RENDER_APP_URL" ]; then
            echo "âš ï¸  Skipping API verification - RENDER_APP_URL not set"
            exit 0
          fi
          
          BASE_URL="$RENDER_APP_URL"
          
          echo "ðŸ§ª Testing API endpoints..."
          
          # Test health endpoint and extract response
          echo "ðŸ“ Testing /health endpoint..."
          HEALTH_RESPONSE=$(curl -s "$BASE_URL/health" || echo "failed")
          
          if echo "$HEALTH_RESPONSE" | grep -q "healthy"; then
            echo "âœ… Health endpoint working"
            echo "ðŸ“Š Response: $HEALTH_RESPONSE"
          else
            echo "âŒ Health endpoint failed"
            echo "ðŸ“Š Response: $HEALTH_RESPONSE"
          fi
          
          # Test API base endpoint
          echo "ðŸ“ Testing /api/v1 endpoint..."
          API_RESPONSE=$(curl -s -w "%{http_code}" "$BASE_URL/api/v1" || echo "failed")
          
          if [[ "$API_RESPONSE" == *"200"* ]] || [[ "$API_RESPONSE" == *"404"* ]]; then
            echo "âœ… API endpoint accessible"
          else
            echo "âš ï¸  API endpoint response: $API_RESPONSE"
          fi

      - name: Deployment Summary
        if: always()
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          echo "ðŸ“‹ Deployment Summary"
          echo "===================="
          echo "ðŸ”— Repository: ${{ github.repository }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ‘¤ Author: ${{ github.event.head_commit.author.name }}"
          echo "ðŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo "â° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          if [ -n "$RENDER_APP_URL" ]; then
            echo "ðŸš€ App URL: $RENDER_APP_URL"
            echo "ðŸ¥ Health: $RENDER_APP_URL/health"
            echo "ðŸ”— API: $RENDER_APP_URL/api/v1"
          else
            echo "âš ï¸  Add RENDER_APP_URL secret for automated verification"
          fi

      - name: Deployment Failure Handler
        if: failure()
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          echo "ðŸš¨ CONTROLLED DEPLOYMENT FAILED"
          echo "==============================="
          echo "âŒ The controlled deployment process failed"
          echo "ðŸ›¡ï¸ Production is PROTECTED - no broken code deployed"
          echo ""
          echo "ðŸ” Troubleshooting steps:"
          echo "1. Check the logs above for specific errors"
          echo "2. Verify GitHub secrets are correctly set:"
          echo "   - RENDER_SERVICE_ID"
          echo "   - RENDER_API_KEY" 
          echo "   - RENDER_APP_URL"
          echo "3. Check Render service status: https://dashboard.render.com"
          echo "4. Review service logs in Render dashboard"
          echo ""
          if [ -n "$RENDER_APP_URL" ]; then
            echo "ðŸŒ App URL: $RENDER_APP_URL"
            echo "ðŸ¥ Health Check: $RENDER_APP_URL/health"
          fi
          echo ""
          echo "âœ… BENEFIT: Failed deployment was caught before affecting users!"

      - name: Success Notification
        if: success()
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
          echo "========================"
          echo "âœ… Quality Gates: PASSED"
          echo "âœ… Build & Deploy: COMPLETED"
          echo "âœ… Health Checks: VERIFIED"
          echo "âœ… Production: UPDATED & SAFE"
          echo ""
          echo "ðŸŒ Your FitRecipes Backend is LIVE!"
          echo "========================"
          if [ -n "$RENDER_APP_URL" ]; then
            echo "ðŸ”— App URL: $RENDER_APP_URL"
            echo "ðŸ¥ Health: $RENDER_APP_URL/health"
            echo "ï¿½ API: $RENDER_APP_URL/api/v1"
          else
            echo "ðŸ’¡ Add RENDER_APP_URL secret for direct links"
          fi
          echo "========================"

  deploy-staging:
    runs-on: ubuntu-latest
    name: Deploy to Staging (Develop)
    needs: [test, build, security]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pre-Deployment Status
        run: |
          echo "âœ… All CI/CD checks passed!"
          echo "í·ª Deploying to STAGING (FREE tier)"
          echo "í³ Commit: ${{ github.event.head_commit.message }}"
          echo "í±¤ Author: ${{ github.event.head_commit.author.name }}"
          echo "í´— Repository: ${{ github.repository }}"
          echo "â° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Deploy to Render (Staging)
        env:
          RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ -z "$RENDER_STAGING_SERVICE_ID" ] || [ -z "$RENDER_API_KEY" ]; then
            echo "âš ï¸  RENDER_STAGING_SERVICE_ID or RENDER_API_KEY secrets not set"
            echo "í³ Render auto-deploy may still be active"
          else
            echo "íº€ Triggering staging deployment..."
            curl -X POST "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json"
            echo "âœ… Staging deployment triggered!"
          fi

      - name: Deployment Summary
        run: |
          echo "## í·ª Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: develop" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Staging (FREE tier)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Deployment triggered" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
